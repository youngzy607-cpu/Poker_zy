<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>德州扑克 v3.3.4</title>
    
    <!-- PWA Support -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icons/icon-192.svg">
    
    <link rel="stylesheet" href="style.css?v=3.3.2">
</head>
<body>
    <!-- Auth Overlay -->
    <div id="auth-overlay" class="lobby-overlay">
        <div class="lobby-box auth-box">
            <h1>德州扑克</h1>
            
            <!-- Login Form -->
            <div id="auth-form-login">
                <div class="lobby-form">
                    <input type="text" id="login-username" class="lobby-input" placeholder="用户名">
                    <input type="password" id="login-password" class="lobby-input" placeholder="密码">
                    <button id="btn-login-submit" class="btn-primary">登录</button>
                </div>
                <div class="auth-switch">
                    还没有账号？ <span id="link-to-register">立即注册</span>
                </div>
            </div>

            <!-- Register Form -->
            <div id="auth-form-register" style="display: none;">
                <div class="lobby-form">
                    <input type="text" id="reg-username" class="lobby-input" placeholder="设置用户名">
                    <input type="password" id="reg-password" class="lobby-input" placeholder="设置密码 (4位以上)">
                    
                    <div class="avatar-selection">
                        <p>选择头像</p>
                        <div class="avatar-grid" id="reg-avatar-grid">
                            <!-- JS injected avatars -->
                        </div>
                        <input type="hidden" id="reg-avatar-id" value="0">
                    </div>

                    <button id="btn-register-submit" class="btn-primary">注册并登录</button>
                </div>
                <div class="auth-switch">
                    已有账号？ <span id="link-to-login">直接登录</span>
                </div>
            </div>

            <div id="auth-message" style="color: #e74c3c; margin-top: 15px; min-height: 20px;"></div>
        </div>
    </div>

    <!-- Main Menu -->
    <div id="main-menu" class="main-menu" style="display: none;">
        <div class="menu-box">
            <h1>德州扑克</h1>
            <div class="menu-chips">当前持有: <span id="menu-chip-count" class="gold">...</span></div>
            <div class="menu-buttons">
                <button id="btn-menu-single" class="btn-menu">单机模式</button>
                <button id="btn-menu-multi" class="btn-menu">联机对战</button>
                <button id="btn-menu-stats" class="btn-menu">个人战绩</button>
                <button id="btn-menu-achievements" class="btn-menu">🏆 成就系统</button>
                <button id="btn-menu-rankings" class="btn-menu">🃏 牌型说明</button>
                <button id="btn-menu-exit" class="btn-menu">退出游戏</button>
            </div>
        </div>
    </div>

    <!-- Achievement Overlay -->
    <div id="achievements-overlay" class="lobby-overlay" style="display: none;">
        <div class="lobby-box achievements-box">
            <h1>成就系统</h1>
            <div class="achievements-list" id="achievements-list">
                <!-- JS injected items -->
            </div>
            <div class="lobby-actions">
                <button id="btn-achievements-close" class="btn-secondary">关闭</button>
            </div>
        </div>
    </div>

    <!-- Stats Overlay -->
    <div id="stats-overlay" class="lobby-overlay" style="display: none;">
        <div class="lobby-box stats-box">
            <h1>个人战绩</h1>
            
            <!-- DEBUG TRIGGER BUTTON (TEMPORARY) -->
            <button onclick="window.game.ui.showAchievementToast({title:'测试成就', reward:999})" style="background:red; color:white; border:none; padding:5px; margin-bottom:10px; cursor:pointer;">
                [调试] 强制触发成就弹窗
            </button>
            
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">当前筹码</div>
                    <div class="stat-value gold" id="stat-chips">1000</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">总局数</div>
                    <div class="stat-value" id="stat-hands">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">胜局数</div>
                    <div class="stat-value" id="stat-wins">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">总盈利</div>
                    <div class="stat-value" id="stat-profit">0</div>
                </div>
                <div class="stat-item wide">
                    <div class="stat-label">最佳牌型</div>
                    <div class="stat-value highlight" id="stat-best-hand">无</div>
                </div>
                <div class="stat-item wide">
                    <div class="stat-label">单局最大底池</div>
                    <div class="stat-value gold" id="stat-biggest-pot">0</div>
                </div>
            </div>
            
            <div class="history-list">
                <h3>最近战绩</h3>
                <div id="history-container">
                    <!-- JS injected history items -->
                </div>
            </div>

            <div class="lobby-actions">
                <button id="btn-stats-close" class="btn-secondary">关闭</button>
                <button id="btn-stats-reset" class="btn-secondary danger" style="display: none;">重置数据</button>
            </div>
        </div>
    </div>

    <!-- Rankings Overlay -->
    <div id="rankings-overlay" class="lobby-overlay" style="display: none;">
        <div class="lobby-box rankings-box">
            <h1>德州扑克牌型大小顺序</h1>
            <div class="rankings-list" id="rankings-list">
                <!-- JS injected items -->
            </div>
            <div class="lobby-actions">
                <button id="btn-rankings-close" class="btn-secondary">关闭</button>
            </div>
        </div>
    </div>

    <!-- Level Up Overlay -->
    <div id="level-up-overlay" class="level-up-overlay" style="display: none;">
        <div class="level-up-box">
            <div class="level-up-title">BLIND LEVEL UP</div>
            <div class="level-up-info">
                <div class="old-blind">
                    <span>10/20</span>
                </div>
                <div class="level-arrow">➜</div>
                <div class="new-blind">
                    <span id="level-up-new-blind">20/40</span>
                </div>
            </div>
            <div class="level-up-desc">盲注级别已提升，节奏加快！</div>
        </div>
    </div>

    <!-- Waiting Host Overlay -->
    <div id="waiting-host-overlay" class="game-overlay-message" style="display: none;">
        <div class="message-content">
            <h2>等待房主开始...</h2>
            <div class="spinner"></div>
        </div>
    </div>

    <!-- Waiting Next Hand Overlay -->
    <div id="waiting-next-hand-overlay" class="game-overlay-message" style="display: none;">
        <div class="message-content">
            <h2>正在进行中</h2>
            <p>请等待本局结束...</p>
            <div class="spinner"></div>
        </div>
    </div>

    <!-- Lobby / Start Screen (Mode Selection & Setup) -->
    <div id="lobby-overlay" class="lobby-overlay" style="display: none;">
        
        <!-- State 1: Mode Selection -->
        <div id="lobby-mode-select" class="lobby-box mode-select-box">
            <h1>选择游戏模式</h1>
            <div class="lobby-info">总资产: <span id="mode-total-chips" class="gold">0</span></div>
            
            <div class="modes-container">
                <div class="mode-card" id="btn-mode-cash">
                    <div class="mode-icon">💰</div>
                    <h3>现金桌</h3>
                    <p>Cash Game</p>
                    <ul class="mode-features">
                        <li>自由买入</li>
                        <li>盲注固定 (5/10)</li>
                        <li>随时离桌</li>
                    </ul>
                </div>

                <div class="mode-card" id="btn-mode-tourney">
                    <div class="mode-icon">🏆</div>
                    <h3>锦标赛</h3>
                    <p>Tournament</p>
                    <ul class="mode-features">
                        <li>报名费 $500</li>
                        <li>前两名瓜分奖池</li>
                        <li>盲注随局数上涨</li>
                    </ul>
                </div>
            </div>

            <div class="lobby-actions">
                <button id="btn-mode-back" class="btn-secondary">返回主菜单</button>
            </div>
        </div>

        <!-- State 2A: Cash Game Setup -->
        <div id="lobby-setup-cash" class="lobby-box" style="display: none;">
            <h1>现金桌设置</h1>
            <div class="lobby-info">可用资金: <span id="cash-total-chips" class="gold">0</span></div>
            
            <p>选择电脑对手数量 (1-5)</p>
            <div class="opponent-selector">
                <input type="range" id="opponent-count" min="1" max="5" value="5" oninput="document.getElementById('count-display').innerText = this.value">
                <span id="count-display">5</span>
            </div>
            
            <p>带入筹码量</p>
            <div class="opponent-selector">
                <input type="range" id="buyin-amount" min="100" max="1000" step="100" value="1000">
                <span id="buyin-display">1000</span>
            </div>

            <div class="lobby-actions">
                <button id="btn-start-cash">开始游戏</button>
                <button id="btn-back-mode-select" class="btn-secondary">返回</button>
            </div>
        </div>

        <!-- State 2B: Tournament Setup -->
        <div id="lobby-setup-tourney" class="lobby-box" style="display: none;">
            <h1>锦标赛大厅</h1>
            <div class="lobby-info">可用资金: <span id="tourney-total-chips" class="gold">0</span></div>
            
            <div class="tourney-info-card">
                <div class="info-row">
                    <span>报名费</span>
                    <span class="gold">$500</span>
                </div>
                <div class="info-row">
                    <span>初始记分牌</span>
                    <span class="white">1500</span>
                </div>
                <div class="info-row">
                    <span>参赛人数</span>
                    <span class="white">5人 (1玩家 + 4电脑)</span>
                </div>
                <div class="info-row">
                    <span>盲注结构</span>
                    <span class="white">每 5 局翻倍</span>
                </div>
                <div class="prize-structure">
                    <h4>奖金分配 (净赚)</h4>
                    <div class="prize-row gold">🥇 冠军: +$1000</div>
                    <div class="prize-row silver">🥈 亚军: +$500</div>
                </div>
            </div>

            <div class="lobby-actions">
                <button id="btn-start-tourney">报名并开始</button>
                <button id="btn-back-mode-select-2" class="btn-secondary">返回</button>
            </div>
        </div>

    </div>

    <div id="online-lobby-overlay" class="lobby-overlay" style="display: none;">
        <div class="lobby-box" style="min-width: 400px;">
            <h1>联机大厅</h1>
            <div class="lobby-form">
                <!-- Nickname input removed, using logged in user -->
                
                <div class="lobby-actions" style="flex-direction: column; gap: 15px;">
                    <div class="create-room-section" style="display: flex; gap: 10px;">
                        <input type="password" id="create-room-pwd" class="lobby-input" placeholder="设置密码(可选)" style="flex: 1;" maxlength="6">
                        <button id="btn-create-room" class="btn-primary" style="flex: 1.5;">创建新房间</button>
                    </div>
                    
                    <div style="display: flex; align-items: center; width: 100%; margin: 5px 0;">
                        <div style="flex: 1; height: 1px; background: #333;"></div>
                        <span style="padding: 0 10px; color: #666; font-size: 0.9em; display: flex; align-items: center; gap: 5px;">
                            房间列表
                            <button id="btn-refresh-rooms" class="icon-btn-small" title="刷新列表">↻</button>
                        </span>
                        <div style="flex: 1; height: 1px; background: #333;"></div>
                    </div>

                    <div id="room-list-container" class="room-list-container">
                        <!-- JS injected rooms -->
                        <div class="room-list-empty">暂无房间，快来创建一个吧！</div>
                    </div>

                    <div class="join-room-section">
                        <input type="text" id="join-room-id" class="lobby-input" placeholder="输入房间号" maxlength="6" style="text-transform: uppercase;">
                        <button id="btn-join-room" class="btn-secondary" style="white-space: nowrap;">加入</button>
                    </div>
                </div>
                
                <div id="lobby-message" style="color: #e74c3c; margin-top: 5px; min-height: 20px; font-size: 0.9em;"></div>
                <button id="btn-lobby-back" class="btn-text">返回主菜单</button>
            </div>
        </div>
    </div>

    <!-- Achievement Notification Overlay (Fixed to Body) -->
    <div id="achievement-notification-container" class="achievement-notification-container"></div>

    <!-- Rebuy / Bankruptcy Modal -->
    <div id="rebuy-overlay" class="lobby-overlay" style="display: none;">
        <div class="lobby-box rebuy-box">
            <h1 id="rebuy-title">筹码不足</h1>
            <div class="lobby-info">当前资产: <span id="rebuy-total-chips" class="gold">0</span></div>
            
            <!-- State A: Has Bankroll (Slider) -->
            <div id="rebuy-content-slider" style="display: none;">
                <p>请选择带入金额</p>
                <div class="opponent-selector">
                    <input type="range" id="rebuy-amount-slider" min="100" max="1000" step="100" value="1000">
                    <span id="rebuy-amount-display">1000</span>
                </div>
                <div class="lobby-actions">
                    <button id="btn-confirm-rebuy" class="btn-primary">带入</button>
                    <button id="btn-cancel-rebuy" class="btn-secondary">离开牌桌</button>
                </div>
            </div>

            <!-- State B: Bankruptcy (Ad) -->
            <div id="rebuy-content-ad" style="display: none;">
                <p class="warning-text">您的资产已耗尽！</p>
                <p>观看广告即可获得 <span class="gold">1000</span> 筹码救济金。</p>
                <div class="lobby-actions">
                    <button id="btn-watch-ad" class="btn-primary">观看广告 (5秒)</button>
                    <button id="btn-give-up" class="btn-secondary">退出游戏</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Fake Ad Overlay -->
    <div id="ad-overlay" class="ad-overlay" style="display: none;">
        <div class="ad-content">
            <div class="ad-spinner"></div>
            <h2>广告播放中...</h2>
            <p>剩余时间: <span id="ad-countdown">5</span> 秒</p>
            <div class="ad-placeholder">
                [ 这是一个假广告 ]<br>
                只有输光的人才能看到我
            </div>
        </div>
    </div>

    <!-- 游戏主界面 -->
    <div class="game-container" style="display: none;">
        <!-- 版本号 (左上角) -->
        <div class="version-tag">v3.3.4</div>

        <!-- 返回主菜单 (右上角，音效左侧) -->
        <button id="btn-back-menu" class="icon-btn" title="返回主菜单">🏠</button>
        <button id="btn-game-rankings" class="icon-btn" title="牌型说明">ℹ️</button>

        <!-- 音效开关 (右上角) -->
        <button id="mute-btn" class="mute-btn" title="开关音效">🔊</button>

        <!-- 桌子背景层 -->
        <div class="table-background">
            <div class="table-felt">
                <div class="table-logo">POKER</div>
            </div>
        </div>

        <!-- 游戏元素层 (绝对定位) -->
        <div class="game-layer">
            <!-- Host Start Button (Centered) -->
            <div id="host-start-container" class="host-start-container" style="display: none;">
                 <button id="btn-host-start" class="btn-primary-large">开始游戏</button>
                 <p class="host-hint">等待玩家加入...</p>
            </div>

            <!-- 公共区域 -->
            <div class="center-area">
                <div class="pot-container">
                    <div class="pot-label">底池</div>
                    <div class="pot-amount" id="pot-amount">0</div>
                </div>
                <div class="community-cards" id="community-cards">
                    <!-- 公共牌 -->
                </div>
                <div id="message-area" class="message-area"></div>
            </div>

            <!-- 对手容器 (JS 动态注入) -->
            <div id="opponents-container"></div>

            <!-- 玩家区域 (固定底部) -->
            <div class="player-seat" id="player-area">
                <!-- 玩家手牌 (绝对定位在头像上方) -->
                <div class="cards" id="player-cards"></div>
                
                <!-- 玩家头像信息 -->
                <div class="avatar-container">
                    <div class="avatar">
                        <div class="avatar-img user-avatar">我</div>
                    </div>
                    <div class="player-info">
                        <div class="name">玩家 (你)</div>
                        <div class="chips-pill">
                            <span class="currency">$</span>
                            <span id="player-chips">1000</span>
                        </div>
                    </div>
                    <!-- 状态气泡 -->
                    <div class="status-bubble" id="player-status"></div>
                </div>
                
                <!-- 牌力提示 -->
                <div id="player-hand-hint" class="hand-hint"></div>
            </div>
        </div>

        <!-- 底部操作栏 -->
        <div class="controls-bar">
            <!-- Main Actions -->
            <div class="action-buttons" id="main-actions">
                <button id="btn-fold" class="btn-action btn-fold" disabled>弃牌</button>
                <button id="btn-check" class="btn-action btn-check" disabled>过牌</button>
                <button id="btn-call" class="btn-action btn-call" disabled>跟注</button>
                <button id="btn-raise" class="btn-action btn-raise" disabled>加注</button>
                <button id="btn-quick-allin" class="btn-action btn-allin" disabled>ALL IN</button>
            </div>
            
            <!-- Raise Inputs (Replaces Main Actions when Raise is clicked) -->
            <div class="raise-inputs" id="raise-inputs" style="display:none;">
                 <div class="slider-row">
                     <button class="btn-adjust minus">-</button>
                     <input type="range" id="raise-slider" min="0" max="100" value="0">
                     <button class="btn-adjust plus">+</button>
                     <span id="raise-amount-display">20</span>
                 </div>
                 <div class="raise-actions-row">
                     <button id="btn-confirm-raise" class="btn-confirm">确定</button>
                     <button id="btn-cancel-raise" class="btn-cancel">取消</button>
                 </div>
            </div>
            
            <button id="btn-restart" class="btn-restart" style="display:none;">再来一局</button>
        </div>
    </div>

    <script src="js/card.js?v=3.3.4"></script>
    <script src="js/audio.js?v=3.3.4"></script>
    <script src="js/evaluator.js?v=3.3.4"></script>
    <script src="js/player.js?v=3.3.4"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="js/data.js?v=3.3.4"></script>
    <script src="js/achievements.js?v=3.3.4"></script>
    <script src="js/network.js?v=3.3.4"></script>
    <script src="js/ui.js?v=3.3.4"></script>
    <script src="js/game_online.js?v=3.3.4"></script>
    <script src="js/game.js?v=3.3.4"></script>
    <script src="js/main.js?v=3.3.4"></script>
    <script>
        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
</body>
</html>